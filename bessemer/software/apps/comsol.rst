.. _comsol_bessemer:

COMSOL Multiphysics
===================

.. sidebar:: COMSOL

   :Version:  5.4
   :Support Level: Install Only
   :Dependencies: None
   :URL: https://www.comsol.com/comsol-multiphysics

COMSOL Multiphysics provides a range of simulation, finite element analysis and solver functionality. 

Availability, licensing and modules
-----------------------------------

COMSOL Multiphysics is installed on Bessemer but is not presently supported by IT Services.  There is no site license for COMSOL so to run it on Bessemer you will need either your own license or access to licenses managed by others.  For example, a research group may operate a *license server* that can issue COMSOL licenses to (approved) users.  If you need access to a license on a temporary basis then you could try contacting `Prof. Will Zimmerman <https://www.sheffield.ac.uk/cbe/academic-staff/professor-will-zimmerman>`_, who has purchased several licenses for his research group and may be willing to hire out licenses to other researchers.  See `Interactive usage (below)` for information on how to specify a COMSOL license when starting COMSOL on Bessemer.

The following COMSOL Multiphysics 5.4 modules are installed:

Electromagnetics Modules

*    AC/DC
*    RF
*    Wave Optics
*    Ray Optics
*    Plasma
*    Semiconductor

Fluid Flow & Heat Transfer Modules

*    CFD
        - Mixer
*    Microfluidics
*    Porous Media Flow
*    Subsurface Flow
*    Pipe Flow
*    Molecular Flow
*    Metal Processing
*    Heat Transfer

Structural Mechanics & Acoustics Modules

*    Structural Mechanics
        - Nonlinear Structural Materials
        - Composite Materials
        - Geomechanics
        - Fatigue
        - Rotordynamics
*    Multibody Dynamics
*    MEMS
*    Acoustics

Chemical Engineering Modules

*    Chemical Reaction Engineering
*    Batteries & Fuel Cells
*    Electrodeposition
*    Corrosion
*    Electrochemistry

Multipurpose

*    Optimization Module
*    Material Library
*    Particle Tracing Module

Interfacing Products

*    LiveLink™ for MATLAB®
*    LiveLink™ for Excel®
*    CAD Import Module
*    Design Module
*    ECAD Import Module
*    LiveLink™ for SOLIDWORKS®
*    LiveLink™ for Inventor®
*    LiveLink™ for AutoCAD®
*    LiveLink™ for Revit®
*    LiveLink™ for PTC® Creo® Parametric™
*    LiveLink™ for PTC® Pro/ENGINEER®
*    LiveLink™ for Solid Edge®
*    File Import for CATIA® V5

Interactive usage
-----------------

After connecting to Bessemer (see :ref:`ssh`),  start an `interactive graphical session <https://docs.hpc.shef.ac.uk/en/latest/hpc/scheduler/submit.html#interactive-sessions>`_.

Next, run the following to make COMSOL Multiphysics available in your current session: ::

        module load COMSOL/5.4

Specify the location of your license information: ::

        export LM_LICENSE_SERVER=/home/myusername/path/to/mylicensefile.dat:$LM_LICENSE_SERVER

The COMSOL Multiphysics user interface should then appear.  Here ``mylicensefile.dat`` is a file containing either:

* details of your license (which components you can use) *or*
* details of the *license server* that you want COMSOL to request licenses from.

If you are using a license server then your license file needs to contain no more than the following: ::

        SERVER mylicenseserver.sheffield.ac.uk machine_id port_number
        USE_SERVER
        
where ``mylicenseserver.sheffield.ac.uk`` is the hostname of your license server and ``port_number`` is the *port* to connect to on that machine to request a COMSOL license.

The person responsible for managing the license server may ask for your Bessemer username to allow you to request licenses (whilst preventing others from doing so).

Finally, start COMSOL Multiphysics: ::

	comsol

Serial batch usage
------------------

To submit a batch job that will run on just one CPU core create a file called e.g. ``batch.sh``: ::

	#!/bin/bash
	#SBATCH --nodes=1
	#SBATCH --mem=2000
	#SBATCH --ntasks-per-node=1
	#SBATCH --time=00:30:00
	#SBATCH --job-name=comsol_test
	#SBATCH --mail-user=Joe.Bloggs@sheffield.ac.uk
	#SBATCH --mail-type=ALL

	module load COMSOL/5.4

	INPFILE=/usr/local/packages/live/eb/COMSOL/5.4/applications/COMSOL_Multiphysics/Fluid_Dynamics/shock_tube.mph
	OUTFILE=shock_tube_results.mph
	BATCHLOG=shock_tube_log.log
	comsol batch -tmpdir $TMPDIR -inputfile $INPFILE -outputfile $OUTFILE -batchlog $BATCHLOG

You may want to change:

- The amount of time that the job is allowed to run for;
- The amount of real (``mem``) memory that the job can use;
- The name of the output file generated by COMSOL (has a ``.mph`` extension);
- The name of the ``BATCHLOG`` log file generated by COMSOL;
- The name of the log file generated by the cluster's scheduling software (which is ``myjob.log`` above).

Next, submit this using: ::

        sbatch batch.sh

and await an email to notify you that the job has completed. Note the results file can be viewed by loading it into the Comsol GUI.

Installation note
-----------------
COMSOL can only be installed, using EasyBuild, by a licensed COMSOL user. Contact Will Zimmerman to be added temporarily to his licensed user list.

